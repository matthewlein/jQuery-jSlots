/*
 * jQuery jSlots Plugin
 * http://matthewlein.com/jslot/
 * Copyright (c) 2011 Matthew Lein
 * Version: 1.0.2 (7/26/2012)
 * Dual licensed under the MIT and GPL licenses
 * Requires: jQuery v1.4.1 or later
 */

(function($){$.jSlots=function(el,options){var base=this;base.$el=$(el);base.el=el;base.$el.data("jSlots",base);base.init=function(){base.options=$.extend({},$.jSlots.defaultOptions,options);base.setup();base.bindEvents();};$.jSlots.defaultOptions={number:3,winnerNumber:1,spinner:'',spinEvent:'click',onStart:$.noop,onEnd:$.noop,onWin:$.noop,easing:'swing',time:7000,loops:6,minimumSpeed:1000,infinite:false,endsAt:[]};base.randomRange=function(low,high){return Math.floor(Math.random()*(1+high-low))+low;};base.isSpinning=false;base.spinSpeed=0;base.winCount=0;base.doneCount=0;base.$liHeight=0;base.$liWidth=0;base.winners=[];base.allSlots=[];base.setup=function(){var $list=base.$el;var $li=$list.find('li').first();base.$liHeight=$li.outerHeight();base.$liWidth=$li.outerWidth();base.liCount=base.$el.children().length;base.listHeight=base.$liHeight*base.liCount;if(base.isInfinite()){base.increment=base.options.minimumSpeed/(base.options.loops-1);}else{base.increment=(base.options.time/base.options.loops)/base.options.loops;}$list.css('position','relative');$li.clone().appendTo($list);base.$wrapper=$list.wrap('<div class="jSlots-wrapper"></div>').parent();base.$el.remove();for(var i=base.options.number-1;i>=0;i--){base.allSlots.push(new base.Slot());}if(!$.isEmptyObject(base.options.endsAt)){$.each(base.allSlots,function(index,val){val.endNum=base.options.endsAt[index];val.isSpinning=false;});}};base.isInfinite=function(){return base.options.infinite;};base.bindEvents=function(){$(base.options.spinner).bind(base.options.spinEvent,function(event){if(!base.isSpinning){base.playSlots();}});};base.stop=function(idx){if($.isArray(idx)){$.each(base.allSlots,function(index,val){val.endNum=idx[index];val.isSpinning=false;});}else{$.each(base.allSlots,function(index,val){if(idx){val.endNum=idx;}val.isSpinning=false;});}};base.Slot=function(){this.spinSpeed=0;this.el=base.$el.clone().appendTo(base.$wrapper)[0];this.$el=$(this.el);this.loopCount=0;this.number=0;this.isSpinning=true;delete this.endNum;};base.Slot.prototype={spinEm:function(){var that=this;that.$el.css('top',-base.listHeight).animate({'top':'0px'},that.spinSpeed,'linear',function(){that.lowerSpeed();});},lowerSpeed:function(){if(!base.isInfinite()||this.loopCount<=base.options.loops){this.spinSpeed+=base.increment;}this.loopCount++;if(this.isSpinning&&(base.isInfinite()||this.loopCount<base.options.loops)){this.spinEm();}else{this.finish();}},finish:function(){var that=this;var endNum=base.randomRange(1,base.liCount);if(this.endNum){endNum=this.endNum;}var finalPos=-((base.$liHeight*endNum)-base.$liHeight);var finalSpeed=((this.spinSpeed*0.5)*(base.liCount))/endNum;that.$el.css('top',-base.listHeight).animate({'top':finalPos},finalSpeed,base.options.easing,function(){that.isSpinning=false;base.checkWinner(endNum,that);});}};base.checkWinner=function(endNum,slot){base.doneCount++;slot.number=endNum;if(($.isArray(base.options.winnerNumber)&&base.options.winnerNumber.indexOf(endNum)>-1)||endNum===base.options.winnerNumber){base.winCount++;base.winners.push(slot.$el);}if(base.doneCount===base.options.number){var finalNumbers=[];$.each(base.allSlots,function(index,val){finalNumbers[index]=val.number;});if($.isFunction(base.options.onEnd)){base.options.onEnd(finalNumbers);}if(base.winCount&&$.isFunction(base.options.onWin)){base.options.onWin(base.winCount,base.winners,finalNumbers);}base.isSpinning=false;}};base.playSlots=function(){base.isSpinning=true;base.winCount=0;base.doneCount=0;base.winners=[];if($.isFunction(base.options.onStart)){base.options.onStart(base);}$.each(base.allSlots,function(index,val){this.spinSpeed=0;this.loopCount=0;this.isSpinning=true;this.spinEm();});};base.onWin=function(){if($.isFunction(base.options.onWin)){base.options.onWin();}};base.init();};$.fn.jSlots=function(options){if(this.length){return this.each(function(){(new $.jSlots(this,options));});}};})(jQuery);